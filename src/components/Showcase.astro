---
const slides = [
  {
    id: 'editor-gongwen',
    zh: '编辑器 · 公文',
    en: 'Editor · Document',
    iframeSrc: '/showcase/editor-gongwen',
    zh_title: '所见即所得',
    en_title: 'What You See Is What You Get',
    zh_desc: '左右分栏实时预览，拖拽分割线自由调整，沉浸式 Markdown 编辑体验。',
    en_desc: 'Side-by-side live preview with draggable splitter. An immersive Markdown editing experience.',
  },
  {
    id: 'editor-jiaoan',
    zh: '编辑器 · 教案',
    en: 'Editor · Lesson Plan',
    iframeSrc: '/showcase/editor-jiaoan',
    zh_title: '教案模板',
    en_title: 'Lesson Plan Template',
    zh_desc: '将 Markdown 格式的实操教案转换为标准表格排版，适合教学场景。',
    en_desc: 'Convert Markdown lesson plans into standard table layouts, perfect for teaching.',
  },
  {
    id: 'batch',
    zh: '批量转换',
    en: 'Batch',
    iframeSrc: '/showcase/batch',
    zh_title: '一键批量导出',
    en_title: 'One-Click Batch Export',
    zh_desc: '拖拽多个文件或 ZIP 包，选择模板，一键批量转换为 PDF 并打包下载。',
    en_desc: 'Drag multiple files or ZIPs, pick a template, batch convert to PDF with one click.',
  },
  {
    id: 'templates',
    zh: '模板',
    en: 'Templates',
    iframeSrc: '/showcase/templates',
    zh_title: '模板管理',
    en_title: 'Template Management',
    zh_desc: '管理内置和社区模板，支持搜索、安装、卸载和从 ZIP 导入。',
    en_desc: 'Manage built-in and community templates. Search, install, uninstall, import from ZIP.',
  },
  {
    id: 'drop',
    zh: '拖入文件',
    en: 'Drag & Drop',
    iframeSrc: '/showcase/drop',
    zh_title: '拖拽导入',
    en_title: 'Drag & Drop Import',
    zh_desc: '将 Markdown 文件直接拖入窗口，自动检测模板并开始转换。',
    en_desc: 'Drag Markdown files into the window. Auto-detect templates and start converting.',
  },
];
---

<section class="showcase section" id="showcase">
  <div class="container">
    <div class="showcase-header animate-on-scroll">
      <div class="section-label">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        <span class="zh">产品展示</span>
        <span class="en">Showcase</span>
      </div>
      <h2 class="section-title">
        <span class="zh">简洁强大的<span class="gradient-text">界面</span></span>
        <span class="en">A Clean & <span class="gradient-text">Powerful</span> Interface</span>
      </h2>
      <p class="section-desc">
        <span class="zh">桌面端原生体验，支持亮色和暗色主题跟随系统切换。</span>
        <span class="en">Native desktop experience with light and dark themes that follow your system.</span>
      </p>
    </div>
  </div>

  <!-- Carousel with peek effect -->
  <div class="carousel animate-on-scroll" id="showcase-carousel" style="transition-delay: 0.15s">
    <div class="carousel-viewport" id="carousel-viewport">
      <div class="carousel-track" id="carousel-track">
        {slides.map((s, i) => (
          <div class={`carousel-slide ${i === 0 ? 'is-active' : ''}`} data-index={i}>
            <div class="slide-card">
              <div class="slide-text">
                <span class="slide-tag">
                  <span class="zh">{s.zh}</span>
                  <span class="en">{s.en}</span>
                </span>
                <h3 class="slide-title">
                  <span class="zh">{s.zh_title}</span>
                  <span class="en">{s.en_title}</span>
                </h3>
                <p class="slide-desc">
                  <span class="zh">{s.zh_desc}</span>
                  <span class="en">{s.en_desc}</span>
                </p>
              </div>
              <div class="slide-image">
                <iframe
                  src={s.iframeSrc}
                  loading="lazy"
                  sandbox="allow-scripts allow-same-origin"
                  class="showcase-iframe"
                  title={s.en}
                ></iframe>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Controls -->
    <div class="carousel-controls">
      <button class="carousel-pause" id="carousel-pause" aria-label="Pause">
        <svg class="icon-pause" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <rect x="5" y="3" width="5" height="18" rx="1"/>
          <rect x="14" y="3" width="5" height="18" rx="1"/>
        </svg>
        <svg class="icon-play" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display:none">
          <polygon points="6,3 20,12 6,21"/>
        </svg>
      </button>
      <div class="carousel-dots" id="carousel-dots">
        {slides.map((_, i) => (
          <button
            class={`carousel-dot ${i === 0 ? 'is-active' : ''}`}
            data-dot={i}
            aria-label={`Slide ${i + 1}`}
          >
            <span class="dot-progress"></span>
          </button>
        ))}
      </div>
    </div>
  </div>
</section>

<script is:inline>
(function () {
  var track = document.getElementById('carousel-track');
  var viewport = document.getElementById('carousel-viewport');
  var pauseBtn = document.getElementById('carousel-pause');
  var dotsWrap = document.getElementById('carousel-dots');
  if (!track || !viewport || !pauseBtn || !dotsWrap) return;

  var slides = track.querySelectorAll('.carousel-slide');
  var dots = dotsWrap.querySelectorAll('.carousel-dot');
  var total = slides.length;
  var current = 0;
  var interval = 5000;
  var timer = null;
  var paused = false;
  var startTime = 0;
  var rafId = null;

  /* Calculate the px offset to center slide[idx] in the viewport */
  function getOffset(idx) {
    var slide = slides[idx];
    if (!slide) return 0;
    var vpW = viewport.offsetWidth;
    var slideLeft = slide.offsetLeft;
    var slideW = slide.offsetWidth;
    return -(slideLeft - (vpW - slideW) / 2);
  }

  function goTo(idx, animate) {
    current = ((idx % total) + total) % total;
    var px = getOffset(current);
    track.style.transition = animate !== false
      ? 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)'
      : 'none';
    track.style.transform = 'translateX(' + px + 'px)';

    for (var i = 0; i < slides.length; i++) {
      slides[i].classList.toggle('is-active', i === current);
    }
    for (var j = 0; j < dots.length; j++) {
      dots[j].classList.toggle('is-active', j === current);
      var prog = dots[j].querySelector('.dot-progress');
      if (prog) { prog.style.transition = 'none'; prog.style.width = '0%'; }
    }
  }

  function startProgress() {
    startTime = Date.now();
    cancelAnimationFrame(rafId);
    var prog = dots[current] ? dots[current].querySelector('.dot-progress') : null;
    if (!prog) return;
    prog.style.transition = 'none';
    prog.style.width = '0%';
    function tick() {
      if (paused) return;
      var pct = Math.min(((Date.now() - startTime) / interval) * 100, 100);
      prog.style.width = pct + '%';
      if (pct < 100) rafId = requestAnimationFrame(tick);
    }
    rafId = requestAnimationFrame(tick);
  }

  function startAuto() {
    stopAuto();
    startProgress();
    timer = setTimeout(function () {
      goTo(current + 1, true);
      startAuto();
    }, interval);
  }

  function stopAuto() {
    clearTimeout(timer);
    cancelAnimationFrame(rafId);
    timer = null;
  }

  /* Pause / Play */
  pauseBtn.addEventListener('click', function () {
    paused = !paused;
    var iPause = pauseBtn.querySelector('.icon-pause');
    var iPlay = pauseBtn.querySelector('.icon-play');
    if (paused) {
      stopAuto();
      iPause.style.display = 'none'; iPlay.style.display = 'block';
    } else {
      iPause.style.display = 'block'; iPlay.style.display = 'none';
      startAuto();
    }
  });

  /* Dot click */
  for (var d = 0; d < dots.length; d++) {
    (function (idx) {
      dots[idx].addEventListener('click', function () {
        if (idx === current) return;
        goTo(idx, true);
        if (!paused) startAuto();
      });
    })(d);
  }

  /* Click on side slides to navigate */
  for (var s = 0; s < slides.length; s++) {
    (function (idx) {
      slides[idx].addEventListener('click', function () {
        if (idx === current) return;
        goTo(idx, true);
        if (!paused) startAuto();
      });
    })(s);
  }

  /* Touch / drag */
  var startX = 0, dragging = false, dragDelta = 0;
  track.addEventListener('touchstart', function (e) {
    startX = e.touches[0].clientX; dragging = true; dragDelta = 0;
    track.style.transition = 'none';
  }, { passive: true });
  track.addEventListener('touchmove', function (e) {
    if (!dragging) return;
    dragDelta = e.touches[0].clientX - startX;
    track.style.transform = 'translateX(' + (getOffset(current) + dragDelta) + 'px)';
  }, { passive: true });
  track.addEventListener('touchend', function () {
    if (!dragging) return;
    dragging = false;
    var threshold = viewport.offsetWidth * 0.12;
    if (dragDelta < -threshold && current < total - 1) goTo(current + 1, true);
    else if (dragDelta > threshold && current > 0) goTo(current - 1, true);
    else goTo(current, true);
    if (!paused) startAuto();
  });

  /* Pause on hover */
  var carouselEl = document.getElementById('showcase-carousel');
  if (carouselEl) {
    carouselEl.addEventListener('mouseenter', function () { if (!paused) stopAuto(); });
    carouselEl.addEventListener('mouseleave', function () { if (!paused) startAuto(); });
  }

  /* Recalc on resize */
  /* Scale showcase iframes to fit container */
  function scaleIframes() {
    var containers = document.querySelectorAll('.slide-image');
    for (var i = 0; i < containers.length; i++) {
      var iframe = containers[i].querySelector('.showcase-iframe');
      if (!iframe) continue;
      var cw = containers[i].offsetWidth;
      var scale = cw / 1200;
      iframe.style.transform = 'scale(' + scale + ')';
      containers[i].style.height = Math.round(800 * scale) + 'px';
    }
  }

  var resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function () { goTo(current, false); scaleIframes(); }, 100);
  });

  /* Init */
  goTo(0, false);
  scaleIframes();
  startAuto();
})();
</script>

<style>
  .showcase-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .showcase-header .section-desc {
    margin-left: auto;
    margin-right: auto;
  }

  /* ============================================
     CAROUSEL — peek adjacent slides
     ============================================ */

  .carousel {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
  }

  .carousel-viewport {
    overflow: hidden;
    /* Extra padding so box-shadows on active card aren't clipped */
    padding: 1rem 0 1.5rem;
  }

  .carousel-track {
    display: flex;
    gap: 2rem;
    will-change: transform;
  }

  /* Each slide takes ~78% of viewport so neighbors peek */
  .carousel-slide {
    flex: 0 0 78%;
    min-width: 0;
    cursor: pointer;
    transition: opacity 0.5s ease, filter 0.5s ease;
    opacity: 0.45;
    filter: saturate(0.6);
  }

  .carousel-slide.is-active {
    opacity: 1;
    filter: saturate(1);
    cursor: default;
  }

  /* ============================================
     SLIDE CARD — vertical: text top, image below
     ============================================ */

  .slide-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 2rem;
    overflow: hidden;
    transition: box-shadow 0.4s ease, border-color 0.4s ease;
  }

  .carousel-slide.is-active .slide-card {
    box-shadow: var(--card-shadow-hover);
    border-color: var(--color-border);
  }

  /* --- Text area --- */

  .slide-text {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-bottom: 1.5rem;
  }

  .slide-tag {
    display: inline-flex;
    align-items: center;
    width: fit-content;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--color-accent);
    background: rgba(59, 130, 246, 0.08);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
  }

  @media (prefers-color-scheme: dark) {
    .slide-tag {
      background: rgba(96, 165, 250, 0.12);
    }
  }

  .slide-title {
    font-size: clamp(1.375rem, 3vw, 1.75rem);
    font-weight: 750;
    line-height: 1.2;
    letter-spacing: -0.02em;
    color: var(--color-text);
  }

  .slide-desc {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    max-width: 540px;
  }

  /* --- Image area: cropped focus --- */

  .slide-image {
    overflow: hidden;
    position: relative;
    border-radius: calc(var(--radius) - 2rem);
  }

  .showcase-iframe {
    width: 1200px;
    height: 800px;
    border: none;
    display: block;
    transform-origin: 0 0;
    pointer-events: none;
  }

  .carousel-slide.is-active .showcase-iframe {
    pointer-events: auto;
  }

  /* ============================================
     CONTROLS — pause + dots
     ============================================ */

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    margin-top: 0.75rem;
    padding-bottom: 0.5rem;
  }

  .carousel-pause {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    transition: all 0.25s ease;
  }

  .carousel-pause:hover {
    color: var(--color-text);
    background: var(--color-bg-elevated);
    border-color: var(--color-text-muted);
    transform: scale(1.08);
  }

  .carousel-dots {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 999px;
    padding: 0.375rem 0.625rem;
  }

  .carousel-dot {
    position: relative;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--color-text-muted);
    opacity: 0.35;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    padding: 0;
  }

  .carousel-dot:hover {
    opacity: 0.6;
  }

  .carousel-dot.is-active {
    width: 32px;
    opacity: 1;
    background: var(--color-border);
  }

  .dot-progress {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0%;
    background: var(--color-accent);
    border-radius: 999px;
  }

  /* ============================================
     RESPONSIVE
     ============================================ */

  @media (max-width: 768px) {
    .carousel-slide {
      flex: 0 0 88%;
    }

    .slide-card {
      padding: 1.5rem;
    }

    .slide-title {
      font-size: 1.25rem;
    }

    .slide-desc {
      font-size: 0.875rem;
    }

    .carousel-dot.is-active {
      width: 24px;
    }
  }

  @media (max-width: 480px) {
    .carousel-slide {
      flex: 0 0 92%;
    }

    .slide-card {
      padding: 1.25rem;
    }
  }

  /* ============================================
     REDUCED MOTION
     ============================================ */

  @media (prefers-reduced-motion: reduce) {
    .carousel-track {
      transition: none !important;
    }
    .carousel-slide {
      transition: none !important;
    }
    .showcase-iframe {
      transition: none !important;
    }
    .dot-progress {
      transition: none !important;
    }
  }
</style>
