name: Sync Release from Presto

on:
  repository_dispatch:
    types: [release-published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sync (e.g. v1.0.0)"
        required: true

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "tag=${{ github.event.client_payload.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch release from Presto
        id: release
        env:
          GH_TOKEN: ${{ secrets.PRESTO_PAT }}
        run: |
          gh api repos/Presto-io/Presto/releases/tags/${{ steps.tag.outputs.tag }} \
            --jq '{name, body, prerelease, draft}' > release.json
          echo "name=$(jq -r .name release.json)" >> "$GITHUB_OUTPUT"
          echo "prerelease=$(jq -r .prerelease release.json)" >> "$GITHUB_OUTPUT"

      - name: Download assets from Presto
        env:
          GH_TOKEN: ${{ secrets.PRESTO_PAT }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          mkdir -p assets
          gh release download "$TAG" --repo Presto-io/Presto --dir assets

      - name: Create release in this repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
          RELEASE_NAME: ${{ steps.release.outputs.name }}
        run: |
          BODY=$(jq -r .body release.json)
          ARGS=(--title "$RELEASE_NAME" --notes "$BODY")
          if [ "$(jq -r .prerelease release.json)" = "true" ]; then
            ARGS+=(--prerelease)
          fi
          gh release create "$TAG" "${ARGS[@]}" assets/*

      - name: Update version in source code
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          # Strip leading 'v' → pure version number
          VER="${TAG#v}"

          # Update Download.astro
          sed -i "s/^const version = '.*';$/const version = '${VER}';/" src/components/Download.astro

          # Update Hero.astro version strings
          sed -i "s/最新版本 v[0-9][0-9.]*/最新版本 v${VER}/" src/components/Hero.astro
          sed -i "s/Latest v[0-9][0-9.]*/Latest v${VER}/" src/components/Hero.astro

      - name: Commit and push version bump
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/components/Download.astro src/components/Hero.astro
          if git diff --cached --quiet; then
            echo "No version changes"
            exit 0
          fi
          git commit -m "chore: 更新版本号至 ${TAG}"
          git push
