import{e as L,g,d as D,b as a}from"./D1kjAdh8.js";import{a as W,t as Z}from"./Dq-C2Gsw.js";import{p as x}from"./BdRA8jgS.js";import{g as F}from"./Bs2XLa2S.js";const p=L({markdown:"",typstSource:"",svgPages:[],selectedTemplate:"",documentDir:"",pendingExternalLoad:!1});let h=D(null),T,w=D(!1),d=null,k=D(!1);function _(o){const r=o.toLowerCase();return r.endsWith(".md")||r.endsWith(".markdown")||r.endsWith(".txt")}function B(o){return o.toLowerCase().endsWith(".zip")}const u={get toast(){return g(h)},showToast(o,r){clearTimeout(T),a(h,{message:o,type:r},!0),T=setTimeout(()=>{a(h,null)},2500)},get confirmVisible(){return g(w)},confirmAccept(){a(w,!1),d?.(!0),d=null},confirmCancel(){a(w,!1),d?.(!1),d=null},get processing(){return g(k)},async promptReplace(){return p.markdown.trim()?(a(w,!0),new Promise(o=>{d=o})):!0},async processFiles(o,r,b,m){if(!(o.length===0&&(!m||m.length===0))){a(k,!0);try{const v=o.filter(t=>B(t.name)),i=[...o.filter(t=>_(t.name))];let c;const f=[],n=new Map;if(b)for(const[t,e]of b)_(t)&&n.set(t,e);if(m&&m.length>0)for(const t of m){f.push(...t.templates),t.workDir&&(c=t.workDir);for(const e of t.markdownFiles){const s=new Blob([e.content],{type:"text/markdown"});i.push(new File([s],e.name,{type:"text/markdown"}));const l=e.workDir||t.workDir;l&&n.set(e.name,l)}}else for(const t of v)try{const e=await W(t);f.push(...e.templates),e.workDir&&(c=e.workDir);for(const s of e.markdownFiles){const l=new Blob([s.content],{type:"text/markdown"});i.push(new File([l],s.name,{type:"text/markdown"}));const y=s.workDir||e.workDir;y&&n.set(s.name,y)}}catch(e){console.error("ZIP import failed:",e),u.showToast(e instanceof Error?e.message:"ZIP 导入失败","error")}if(f.length>0){await Z.refresh();const t=f.filter(e=>e.status!=="skipped").map(e=>e.displayName||e.name);t.length>0&&u.showToast(`模板 "${t.join("、")}" 导入成功`,"success")}if(i.length===0){f.length===0&&u.showToast("未找到可导入的文件","error");return}if(r==="/batch"){x.set({files:i,workDir:c,documentDirs:n.size>0?n:void 0});return}if(i.length===1){if(!await u.promptReplace())return;const e=i[0],s=await e.text(),l=n.get(e.name)||c||"";p.markdown=s,p.documentDir=l,p.pendingExternalLoad=!0,r!=="/"&&await F("/")}else x.set({files:i,workDir:c,documentDirs:n.size>0?n:void 0}),r!=="/batch"&&await F("/batch")}finally{a(k,!1)}}}};export{p as e,u as f};
