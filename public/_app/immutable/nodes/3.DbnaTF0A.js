import{a as g,f as b,c as it}from"../chunks/C39mV9My.js";import{o as Xe,a as lt}from"../chunks/BN5aVeYL.js";import{p as $e,H as qe,g as t,b as r,t as me,a as He,d as w,s as c,c as i,r as l,u as ne,f as Oe,G as ct}from"../chunks/D1kjAdh8.js";import{d as Ye,a as f,s as Ee,e as ze}from"../chunks/Oi55ULqo.js";import{p as dt,i as P}from"../chunks/DHvLmY1O.js";import{a as De,b as H,e as Je,r as vt,c as We,i as ut}from"../chunks/ThjiEXdU.js";import{b as re}from"../chunks/CQL5r_eC.js";import{E as mt}from"../chunks/CvbJ5qIv.js";import{P as pt}from"../chunks/BHIhPDTn.js";import{t as ft,c as gt,f as ht}from"../chunks/DYyef2Au.js";import{b as wt}from"../chunks/Cxk7Thdo.js";import{g as q}from"../chunks/D-UU5hfZ.js";import{t as Se,c as bt,b as _t,d as yt,g as kt}from"../chunks/Dq-C2Gsw.js";import{C as Tt}from"../chunks/C0WG7m6E.js";import{T as Ke,S as xt}from"../chunks/CjYwgKXw.js";import{S as Et}from"../chunks/Vq_ulvgH.js";import{e as o,f as Ge}from"../chunks/DajPFPQ-.js";import{e as Dt,r as St}from"../chunks/CWZOTtjW.js";import{s as Ct,t as Ve}from"../chunks/DElPTFiF.js";import{S as Pt}from"../chunks/DklJKVlF.js";import{F as Rt,L as Ft}from"../chunks/DFpmJrk3.js";import{D as At}from"../chunks/C_p730kY.js";import{E as Lt}from"../chunks/C4LT53z4.js";var Mt=b('<span class="selector-warn svelte-17yjec1" title="缺少字体"><!></span>'),jt=b('<div class="selector-search svelte-17yjec1"><!> <input type="text" placeholder="搜索模板…" class="svelte-17yjec1"/></div>'),Ot=b('<span class="option-warn svelte-17yjec1" title="缺少字体"><!></span>'),zt=b('<button role="option"><span class="option-label svelte-17yjec1"> </span> <!></button>'),Kt=b('<div class="selector-empty-guide svelte-17yjec1"><!> <span>尚未安装模板</span> <button class="guide-link svelte-17yjec1">前往模板商店</button></div>'),Ut=b('<div class="selector-empty svelte-17yjec1">无匹配模板</div>'),Bt=b('<div class="selector-dropdown svelte-17yjec1" role="listbox"><!> <div class="selector-options svelte-17yjec1"><!> <!></div></div>'),Nt=b('<div class="selector-wrapper svelte-17yjec1"><button aria-haspopup="listbox" aria-label="选择模板"><span class="selector-label svelte-17yjec1"> </span> <!> <!></button> <!></div>');function Zt(Ce,M){$e(M,!0);let _=dt(M,"selected",15,""),S=ne(()=>Se.templates),m=w(!1),E=w(""),d=w(0),j,Z,Y=w(void 0),O=ne(()=>t(S).length>=7),R=ne(()=>t(S).filter(n=>{if(!t(E))return!0;const y=t(E).toLowerCase();return(n.displayName||n.name).toLowerCase().includes(y)||n.name.toLowerCase().includes(y)})),oe=ne(()=>t(S).find(n=>n.name===_())?.displayName||t(S).find(n=>n.name===_())?.name||_()||"选择模板"),J=ne(()=>(t(S).find(n=>n.name===_())?.missingFonts?.length??0)>0);Xe(()=>(Se.load().then(()=>{!_()&&t(S).length>0&&(M.onbeforechange?M.onbeforechange(t(S)[0].name):_(t(S)[0].name))}),document.addEventListener("pointerdown",F,!0),()=>document.removeEventListener("pointerdown",F,!0)));function I(){r(m,!t(m)),t(m)&&(r(E,""),r(d,Math.max(0,t(R).findIndex(n=>n.name===_())),!0),requestAnimationFrame(()=>t(Y)?.focus()))}function W(n){r(m,!1),r(E,""),M.onbeforechange?M.onbeforechange(n):_(n),Z?.focus()}function G(n){if(!t(m)){(n.key==="Enter"||n.key===" "||n.key==="ArrowDown")&&(n.preventDefault(),I());return}switch(n.key){case"ArrowDown":n.preventDefault(),r(d,Math.min(t(d)+1,t(R).length-1),!0);break;case"ArrowUp":n.preventDefault(),r(d,Math.max(t(d)-1,0),!0);break;case"Enter":n.preventDefault(),t(R)[t(d)]&&W(t(R)[t(d)].name);break;case"Escape":n.preventDefault(),r(m,!1),Z?.focus();break}}function F(n){t(m)&&j&&!j.contains(n.target)&&r(m,!1)}qe(()=>{t(E),r(d,0)});var z=Nt(),A=i(z);let pe;var se=i(A),Pe=i(se,!0);l(se);var fe=c(se,2);{var L=n=>{var y=Mt(),Q=i(y);Ke(Q,{size:11}),l(y),g(n,y)};P(fe,n=>{t(J)&&n(L)})}var K=c(fe,2);Tt(K,{size:12}),l(A),re(A,n=>Z=n,()=>Z);var ge=c(A,2);{var Re=n=>{var y=Bt(),Q=i(y);{var Fe=h=>{var v=jt(),D=i(v);Et(D,{size:12});var p=c(D,2);vt(p),re(p,C=>r(Y,C),()=>t(Y)),l(v),wt(p,()=>t(E),C=>r(E,C)),g(h,v)};P(Q,h=>{t(O)&&h(Fe)})}var he=c(Q,2),V=i(he);Je(V,19,()=>t(R),h=>h.name,(h,v,D)=>{var p=zt();let C;var T=i(p),k=i(T,!0);l(T);var X=c(T,2);{var ie=U=>{var ee=Ot(),$=i(ee);Ke($,{size:10}),l(ee),g(U,ee)};P(X,U=>{(t(v).missingFonts?.length??0)>0&&U(ie)})}l(p),me(()=>{C=De(p,1,"selector-option svelte-17yjec1",null,C,{selected:t(v).name===_(),highlighted:t(D)===t(d)}),H(p,"aria-selected",t(v).name===_()),Ee(k,t(v).displayName||t(v).name)}),f("click",p,()=>W(t(v).name)),ze("pointerenter",p,()=>r(d,t(D),!0)),g(h,p)});var we=c(V,2);{var be=h=>{var v=it(),D=Oe(v);{var p=T=>{var k=Kt(),X=i(k);xt(X,{size:16});var ie=c(X,4);l(k),f("click",ie,()=>{r(m,!1),q("/store-templates")}),g(T,k)},C=T=>{var k=Ut();g(T,k)};P(D,T=>{t(S).length===0?T(p):T(C,!1)})}g(h,v)};P(we,h=>{t(R).length===0&&h(be)})}l(he),l(y),ft(3,y,()=>ht,()=>({y:-4,duration:150,easing:gt})),g(n,y)};P(ge,n=>{t(m)&&n(Re)})}l(z),re(z,n=>j=n,()=>j),me(()=>{pe=De(A,1,"selector-trigger svelte-17yjec1",null,pe,{open:t(m)}),H(A,"aria-expanded",t(m)),Ee(Pe,t(oe))}),f("keydown",z,G),f("click",A,I),g(Ce,z),He()}Ye(["keydown","click"]);var It=b('<div class="status-dot svelte-1uha8ag"></div>'),Wt=b('<span class="error-msg svelte-1uha8ag"> </span>'),Gt=b('<span class="font-sep svelte-1uha8ag">、</span>'),Vt=b('<!> <a target="_blank" rel="noopener noreferrer" class="svelte-1uha8ag"> <!></a>',1),Xt=b('<div class="font-warning svelte-1uha8ag"><!> <span class="svelte-1uha8ag">缺少字体：</span> <!></div>'),$t=b('<div class="toolbar svelte-1uha8ag" style="--wails-draggable:drag"><div class="toolbar-left svelte-1uha8ag"><!> <!></div> <div class="toolbar-right svelte-1uha8ag"><!> <div><button class="btn-toolbar svelte-1uha8ag" aria-label="设置"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="打开文件"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="批量转换" title="批量转换"><!></button></div> <button class="btn-export svelte-1uha8ag" aria-label="导出 PDF"><!> <span class="svelte-1uha8ag">导出 PDF</span></button></div></div> <!> <div><div class="pane svelte-1uha8ag"><!></div> <div class="divider svelte-1uha8ag" role="separator" aria-label="拖动调整宽度" aria-orientation="vertical"><div class="divider-grip svelte-1uha8ag"><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span></div></div> <div class="pane svelte-1uha8ag"><!></div></div> <dialog class="confirm-dialog svelte-1uha8ag"><h3 class="svelte-1uha8ag">切换模板</h3> <p class="svelte-1uha8ag">当前编辑器中有内容，切换模板后如何处理？</p> <div class="dialog-actions svelte-1uha8ag"><button class="dialog-btn primary svelte-1uha8ag">使用示例内容</button> <button class="dialog-btn svelte-1uha8ag">保留当前内容</button> <button class="dialog-btn svelte-1uha8ag">取消</button></div></dialog>',1);function wa(Ce,M){$e(M,!0);let _=ne(()=>Se.templates.find(e=>e.name===o.selectedTemplate)?.missingFonts??[]);const m=typeof navigator<"u"&&/Mac|iPhone|iPad/.test(navigator.userAgent)?"⌘":"Ctrl+";let E=w(!1),d=w(""),j=w(!1);qe(()=>{o.pendingExternalLoad&&(o.pendingExternalLoad=!1,r(j,!1),Fe(o.markdown),V(o.markdown))});let Z=w(0),Y=w(0),O=w(null),R,oe=w(.5),J=w(!1),I,W,G=w(!1),F;function z(){clearTimeout(F),r(G,!0)}function A(){clearTimeout(F),F=setTimeout(()=>{r(G,!1)},800)}function pe(e){if(!W)return;const a=W.getBoundingClientRect(),s=60;e.clientX>=a.left-s&&e.clientX<=a.right+s&&e.clientY>=a.top-s&&e.clientY<=a.bottom+s?z():t(G)&&(clearTimeout(F),F=setTimeout(()=>{r(G,!1)},800))}lt(()=>{clearTimeout(F)});function se(e){r(J,!0),e.target.setPointerCapture(e.pointerId)}function Pe(e){if(!t(J)||!I)return;const a=I.getBoundingClientRect(),s=(e.clientX-a.left)/a.width;r(oe,Math.min(.8,Math.max(.2,s)),!0)}function fe(){r(J,!1)}let L=w(""),K;async function ge(e){try{const a=await kt(e);a&&(o.markdown=a,V(o.markdown))}catch(a){console.error("Failed to load example:",a)}}async function Re(e){e!==o.selectedTemplate&&(o.markdown.trim()?(r(L,e,!0),K?.showModal()):(o.selectedTemplate=e,await ge(e)))}function n(){K?.close(),o.selectedTemplate=t(L),ge(t(L)),r(L,"")}function y(){K?.close(),o.selectedTemplate=t(L),V(o.markdown),r(L,"")}function Q(){K?.close(),r(L,"")}function Fe(e){if(t(j))return;r(j,!0);const a=Dt(e);if(!a)return;const s=St(a,Se.templates);s&&s!==o.selectedTemplate&&(o.selectedTemplate=s)}function he(e){const a=e.split(`
`);for(let s=1;s<=5;s++){const u="=".repeat(s)+" ",x="=".repeat(s+1);for(const B of a){const de=B.trim();if(!de.startsWith(u)||s<5&&de.startsWith(x))continue;let N=de.slice(u.length).trim();if(N.startsWith("#")){let te=N.slice(1);const ae=te.search(/[.( ]/);ae>0&&(te=te.slice(0,ae));const Te=te.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),je=new RegExp(`#let\\s+${Te}\\s*=\\s*"([^"]*)"`);for(const ue of a){const xe=ue.match(je);if(xe){N=xe[1];break}}if(N.startsWith("#"))continue}const ve=N.trim().replace(/[/\\:*?"<>|]/g,"_");if(ve)return ve}}return"output"}async function V(e){!o.selectedTemplate||!e.trim()||(r(d,""),e.includes("![")&&Ct("image-path")&&Ve("image-path"),clearTimeout(R),R=setTimeout(async()=>{r(E,!0);try{o.typstSource=await bt(e,o.selectedTemplate),window.go?.main?.App?.CompileSVG?o.svgPages=await window.go.main.App.CompileSVG(o.typstSource,o.documentDir):o.svgPages=await _t(o.typstSource,o.documentDir||void 0)}catch(a){const s=a instanceof Error?a.message:String(a);console.error("Convert failed:",s),r(d,s,!0),/image|图片|not found|file not|读取/.test(s.toLowerCase())&&setTimeout(()=>Ve("image-error"),500)}finally{r(E,!1)}},500))}async function we(){if(!(!o.selectedTemplate||!o.markdown.trim())){r(d,"");try{if(window.go?.main?.App?.SavePDF){await window.go.main.App.SavePDF(o.markdown,o.selectedTemplate,o.documentDir);return}const e=await yt(o.markdown,o.selectedTemplate,o.documentDir||void 0),a=URL.createObjectURL(e),s=document.createElement("a");s.href=a,s.download=he(o.typstSource)+".pdf",s.click(),URL.revokeObjectURL(a)}catch(e){const a=e instanceof Error?e.message:String(e);console.error("Download failed:",a),r(d,a,!0)}}}async function be(){try{let e,a;if(window.go?.main?.App?.OpenFiles){const s=await window.go.main.App.OpenFiles();if(!s||s.length===0)return;a=new Map;const u=[];e=[];for(const x of s)if(x.isZip&&x.path&&window.go.main.App.ImportBatchZip)try{const B=await window.go.main.App.ImportBatchZip(x.path);u.push(B)}catch(B){console.error("ImportBatchZip failed:",B)}else x.isZip||(a.set(x.name,x.dir),e.push(new File([x.content],x.name,{type:"text/markdown"})));if(e.length===0&&u.length===0)return;await Ge.processFiles(e,"/",a,u.length>0?u:void 0);return}else e=await new Promise(s=>{const u=document.createElement("input");u.type="file",u.accept=".md,.markdown,.txt,.zip",u.multiple=!0,u.onchange=()=>s(Array.from(u.files??[])),u.click()});if(e.length===0)return;await Ge.processFiles(e,"/",a)}catch(e){const a=e instanceof Error?e.message:String(e);r(d,a,!0)}}Xe(()=>{window.runtime?.EventsOn&&(window.runtime.EventsOn("menu:open",be),window.runtime.EventsOn("menu:export",we),window.runtime.EventsOn("menu:settings",()=>q("/settings")),window.runtime.EventsOn("menu:templates",()=>q("/settings")));function e(a){(a.metaKey||a.ctrlKey)&&a.key===","&&(a.preventDefault(),q("/settings")),(a.metaKey||a.ctrlKey)&&a.shiftKey&&(a.key==="t"||a.key==="T")&&(a.preventDefault(),q("/settings"))}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)});var h=$t(),v=Oe(h),D=i(v),p=i(D);Zt(p,{get selected(){return o.selectedTemplate},onbeforechange:Re});var C=c(p,2);{var T=e=>{var a=It();g(e,a)};P(C,e=>{t(E)&&e(T)})}l(D);var k=c(D,2),X=i(k);{var ie=e=>{var a=Wt(),s=i(a,!0);l(a),me(()=>{H(a,"title",t(d)),Ee(s,t(d))}),g(e,a)};P(X,e=>{t(d)&&e(ie)})}var U=c(X,2);let ee;var $=i(U),Qe=i($);Pt(Qe,{size:14}),l($);var le=c($,2),et=i(le);Rt(et,{size:14}),l(le);var Ae=c(le,2),tt=i(Ae);Ft(tt,{size:14}),l(Ae),l(U);var _e=c(U,2),at=i(_e);At(at,{size:14}),ct(2),l(_e),l(k),re(k,e=>W=e,()=>W),l(v);var Ue=c(v,2);{var nt=e=>{var a=Xt(),s=i(a);Ke(s,{size:13});var u=c(s,4);Je(u,17,()=>t(_),ut,(x,B,de)=>{var N=Vt(),ve=Oe(N);{var te=ue=>{var xe=Gt();g(ue,xe)};P(ve,ue=>{de>0&&ue(te)})}var ae=c(ve,2),Te=i(ae),je=c(Te);Lt(je,{size:10}),l(ae),me(()=>{H(ae,"href",t(B).url),Ee(Te,`${t(B).displayName??""} `)}),g(x,N)}),l(a),g(e,a)};P(Ue,e=>{t(_).length>0&&e(nt)})}var ce=c(Ue,2);let Be;var ye=i(ce),rt=i(ye);mt(rt,{onchange:V,get scrollRatio(){return t(Z)},onscroll:e=>{t(O)!=="preview"&&(r(O,"editor"),r(Y,e,!0),setTimeout(()=>{r(O,null)},100))},get value(){return o.markdown},set value(e){o.markdown=e}}),l(ye);var ke=c(ye,2),Le=c(ke,2),ot=i(Le);pt(ot,{get svgPages(){return o.svgPages},get scrollRatio(){return t(Y)},onscroll:e=>{t(O)!=="editor"&&(r(O,"preview"),r(Z,e,!0),setTimeout(()=>{r(O,null)},100))}}),l(Le),l(ce),re(ce,e=>I=e,()=>I);var Me=c(ce,2),Ne=c(i(Me),4),Ze=i(Ne),Ie=c(Ze,2),st=c(Ie,2);l(Ne),l(Me),re(Me,e=>K=e,()=>K),me(()=>{ee=De(U,1,"toolbar-hidden-group svelte-1uha8ag",null,ee,{visible:t(G)}),H($,"title",`设置 (${m},)`),H(le,"title",`打开文件 (${m}O)`),H(_e,"title",`导出 PDF (${m}E)`),Be=De(ce,1,"editor-layout svelte-1uha8ag",null,Be,{dragging:t(J)}),We(ye,`flex: ${t(oe)??""}`),We(Le,`flex: ${1-t(oe)}`)}),f("mousemove",v,pe),ze("mouseenter",k,z),ze("mouseleave",k,A),f("click",$,()=>q("/settings")),f("click",le,be),f("click",Ae,()=>q("/batch")),f("click",_e,we),f("pointerdown",ke,se),f("pointermove",ke,Pe),f("pointerup",ke,fe),f("click",Ze,n),f("click",Ie,y),f("click",st,Q),g(Ce,h),He()}Ye(["mousemove","click","pointerdown","pointermove","pointerup"]);export{wa as component};
