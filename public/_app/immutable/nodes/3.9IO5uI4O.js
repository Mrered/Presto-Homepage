import{c as it,a as _,f as y}from"../chunks/zz4pAW5t.js";import{o as Ve,a as lt}from"../chunks/aHgiBJh1.js";import{f as je,p as Xe,H as qe,g as t,b as r,t as ve,a as He,d as w,s as c,c as i,r as l,G as te,F as ct}from"../chunks/DdHHCz2d.js";import{d as Ye,a as h,s as Ee,e as Oe}from"../chunks/B1nNSMqB.js";import{l as dt,s as ut,p as vt,i as A}from"../chunks/BJJAIwca.js";import{I as pt,s as mt,a as De,b as V,e as Je,r as ft,c as Ze,i as gt}from"../chunks/0vhbyHiM.js";import{b as ae}from"../chunks/BuQ4--zT.js";import{E as ht}from"../chunks/CTon4bOM.js";import{P as wt}from"../chunks/DAvGkWzf.js";import{t as _t,c as bt,f as yt,s as kt,a as We}from"../chunks/CJmKLHke.js";import{b as Tt}from"../chunks/cu_Hgjv4.js";import{t as Se,c as xt,a as Et,b as Dt,g as St}from"../chunks/CTzFK-sy.js";import"../chunks/gMsrDP8M.js";import{T as ze,E as Pt}from"../chunks/BdW6Qf7w.js";import{S as Ft}from"../chunks/CRdhvj4_.js";import{g as ee}from"../chunks/kdogHk8D.js";import{e as o,f as Ge}from"../chunks/D-Rx0OVB.js";import{e as Rt,r as Ct}from"../chunks/CWZOTtjW.js";import{S as At}from"../chunks/Bku8nPrm.js";import{F as Lt,L as Mt}from"../chunks/B1HYaQJY.js";import{D as $t}from"../chunks/RJDjesxt.js";function jt(ne,x){const m=dt(x,["children","$$slots","$$events","$$legacy"]);const E=[["path",{d:"m6 9 6 6 6-6"}]];pt(ne,ut({name:"chevron-down"},()=>m,{get iconNode(){return E},children:(u,k)=>{var d=it(),D=je(d);mt(D,x,"default",{}),_(u,d)},$$slots:{default:!0}}))}var Ot=y('<span class="selector-warn svelte-17yjec1" title="缺少字体"><!></span>'),zt=y('<div class="selector-search svelte-17yjec1"><!> <input type="text" placeholder="搜索模板…" class="svelte-17yjec1"/></div>'),Kt=y('<span class="option-warn svelte-17yjec1" title="缺少字体"><!></span>'),Nt=y('<button role="option"><span class="option-label svelte-17yjec1"> </span> <!></button>'),Ut=y('<div class="selector-empty svelte-17yjec1">无匹配模板</div>'),Bt=y('<div class="selector-dropdown svelte-17yjec1" role="listbox"><!> <div class="selector-options svelte-17yjec1"><!> <!></div></div>'),It=y('<div class="selector-wrapper svelte-17yjec1"><button aria-haspopup="listbox" aria-label="选择模板"><span class="selector-label svelte-17yjec1"> </span> <!> <!></button> <!></div>');function Zt(ne,x){Xe(x,!0);let m=vt(x,"selected",15,""),E=te(()=>Se.templates),u=w(!1),k=w(""),d=w(0),D,N,X=w(void 0),L=te(()=>t(E).length>=7),S=te(()=>t(E).filter(n=>{if(!t(k))return!0;const b=t(k).toLowerCase();return(n.displayName||n.name).toLowerCase().includes(b)||n.name.toLowerCase().includes(b)})),re=te(()=>t(E).find(n=>n.name===m())?.displayName||t(E).find(n=>n.name===m())?.name||m()||"选择模板"),q=te(()=>(t(E).find(n=>n.name===m())?.missingFonts?.length??0)>0);Ve(()=>(Se.load().then(()=>{!m()&&t(E).length>0&&(x.onbeforechange?x.onbeforechange(t(E)[0].name):m(t(E)[0].name))}),document.addEventListener("pointerdown",P,!0),()=>document.removeEventListener("pointerdown",P,!0)));function U(){r(u,!t(u)),t(u)&&(r(k,""),r(d,Math.max(0,t(S).findIndex(n=>n.name===m())),!0),requestAnimationFrame(()=>t(X)?.focus()))}function B(n){r(u,!1),r(k,""),x.onbeforechange?x.onbeforechange(n):m(n),N?.focus()}function I(n){if(!t(u)){(n.key==="Enter"||n.key===" "||n.key==="ArrowDown")&&(n.preventDefault(),U());return}switch(n.key){case"ArrowDown":n.preventDefault(),r(d,Math.min(t(d)+1,t(S).length-1),!0);break;case"ArrowUp":n.preventDefault(),r(d,Math.max(t(d)-1,0),!0);break;case"Enter":n.preventDefault(),t(S)[t(d)]&&B(t(S)[t(d)].name);break;case"Escape":n.preventDefault(),r(u,!1),N?.focus();break}}function P(n){t(u)&&D&&!D.contains(n.target)&&r(u,!1)}qe(()=>{t(k),r(d,0)});var M=It(),F=i(M);let pe;var oe=i(F),Pe=i(oe,!0);l(oe);var me=c(oe,2);{var R=n=>{var b=Ot(),H=i(b);ze(H,{size:11}),l(b),_(n,b)};A(me,n=>{t(q)&&n(R)})}var $=c(me,2);jt($,{size:12}),l(F),ae(F,n=>N=n,()=>N);var fe=c(F,2);{var Fe=n=>{var b=Bt(),H=i(b);{var Re=f=>{var v=zt(),C=i(v);Ft(C,{size:12});var g=c(C,2);ft(g),ae(g,j=>r(X,j),()=>t(X)),l(v),Tt(g,()=>t(k),j=>r(k,j)),_(f,v)};A(H,f=>{t(L)&&f(Re)})}var ge=c(H,2),Z=i(ge);Je(Z,19,()=>t(S),f=>f.name,(f,v,C)=>{var g=Nt();let j;var se=i(g),W=i(se,!0);l(se);var _e=c(se,2);{var Ce=O=>{var Y=Kt(),G=i(Y);ze(G,{size:10}),l(Y),_(O,Y)};A(_e,O=>{(t(v).missingFonts?.length??0)>0&&O(Ce)})}l(g),ve(()=>{j=De(g,1,"selector-option svelte-17yjec1",null,j,{selected:t(v).name===m(),highlighted:t(C)===t(d)}),V(g,"aria-selected",t(v).name===m()),Ee(W,t(v).displayName||t(v).name)}),h("click",g,()=>B(t(v).name)),Oe("pointerenter",g,()=>r(d,t(C),!0)),_(f,g)});var he=c(Z,2);{var we=f=>{var v=Ut();_(f,v)};A(he,f=>{t(S).length===0&&f(we)})}l(ge),l(b),_t(3,b,()=>yt,()=>({y:-4,duration:150,easing:bt})),_(n,b)};A(fe,n=>{t(u)&&n(Fe)})}l(M),ae(M,n=>D=n,()=>D),ve(()=>{pe=De(F,1,"selector-trigger svelte-17yjec1",null,pe,{open:t(u)}),V(F,"aria-expanded",t(u)),Ee(Pe,t(re))}),h("keydown",M,I),h("click",F,U),_(ne,M),He()}Ye(["keydown","click"]);var Wt=y('<div class="status-dot svelte-1uha8ag"></div>'),Gt=y('<span class="error-msg svelte-1uha8ag"> </span>'),Vt=y('<span class="font-sep svelte-1uha8ag">、</span>'),Xt=y('<!> <a target="_blank" rel="noopener noreferrer" class="svelte-1uha8ag"> <!></a>',1),qt=y('<div class="font-warning svelte-1uha8ag"><!> <span class="svelte-1uha8ag">缺少字体：</span> <!></div>'),Ht=y('<div class="toolbar svelte-1uha8ag" style="--wails-draggable:drag"><div class="toolbar-left svelte-1uha8ag"><!> <!></div> <div class="toolbar-right svelte-1uha8ag"><!> <div><button class="btn-toolbar svelte-1uha8ag" aria-label="设置"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="打开文件"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="批量转换" title="批量转换"><!></button></div> <button class="btn-export svelte-1uha8ag" aria-label="导出 PDF"><!> <span class="svelte-1uha8ag">导出 PDF</span></button></div></div> <!> <div><div class="pane svelte-1uha8ag"><!></div> <div class="divider svelte-1uha8ag" role="separator" aria-label="拖动调整宽度" aria-orientation="vertical"><div class="divider-grip svelte-1uha8ag"><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span></div></div> <div class="pane svelte-1uha8ag"><!></div></div> <dialog class="confirm-dialog svelte-1uha8ag"><h3 class="svelte-1uha8ag">切换模板</h3> <p class="svelte-1uha8ag">当前编辑器中有内容，切换模板后如何处理？</p> <div class="dialog-actions svelte-1uha8ag"><button class="dialog-btn primary svelte-1uha8ag">使用示例内容</button> <button class="dialog-btn svelte-1uha8ag">保留当前内容</button> <button class="dialog-btn svelte-1uha8ag">取消</button></div></dialog>',1);function wa(ne,x){Xe(x,!0);let m=te(()=>Se.templates.find(e=>e.name===o.selectedTemplate)?.missingFonts??[]);const u=typeof navigator<"u"&&/Mac|iPhone|iPad/.test(navigator.userAgent)?"⌘":"Ctrl+";let k=w(!1),d=w(""),D=w(!1);qe(()=>{o.pendingExternalLoad&&(o.pendingExternalLoad=!1,r(D,!1),Re(o.markdown),Z(o.markdown))});let N=w(0),X=w(0),L=w(null),S,re=w(.5),q=w(!1),U,B,I=w(!1),P;function M(){clearTimeout(P),r(I,!0)}function F(){clearTimeout(P),P=setTimeout(()=>{r(I,!1)},800)}function pe(e){if(!B)return;const a=B.getBoundingClientRect(),s=60;e.clientX>=a.left-s&&e.clientX<=a.right+s&&e.clientY>=a.top-s&&e.clientY<=a.bottom+s?M():t(I)&&(clearTimeout(P),P=setTimeout(()=>{r(I,!1)},800))}lt(()=>{clearTimeout(P)});function oe(e){r(q,!0),e.target.setPointerCapture(e.pointerId)}function Pe(e){if(!t(q)||!U)return;const a=U.getBoundingClientRect(),s=(e.clientX-a.left)/a.width;r(re,Math.min(.8,Math.max(.2,s)),!0)}function me(){r(q,!1)}let R=w(""),$;async function fe(e){try{const a=await St(e);a&&(o.markdown=a,Z(o.markdown))}catch(a){console.error("Failed to load example:",a)}}async function Fe(e){e!==o.selectedTemplate&&(o.markdown.trim()?(r(R,e,!0),$?.showModal()):(o.selectedTemplate=e,await fe(e)))}function n(){$?.close(),o.selectedTemplate=t(R),fe(t(R)),r(R,"")}function b(){$?.close(),o.selectedTemplate=t(R),Z(o.markdown),r(R,"")}function H(){$?.close(),r(R,"")}function Re(e){if(t(D))return;r(D,!0);const a=Rt(e);if(!a)return;const s=Ct(a,Se.templates);s&&s!==o.selectedTemplate&&(o.selectedTemplate=s)}function ge(e){const a=e.split(`
`);for(let s=1;s<=5;s++){const p="=".repeat(s)+" ",T="=".repeat(s+1);for(const z of a){const ce=z.trim();if(!ce.startsWith(p)||s<5&&ce.startsWith(T))continue;let K=ce.slice(p.length).trim();if(K.startsWith("#")){let J=K.slice(1);const Q=J.search(/[.( ]/);Q>0&&(J=J.slice(0,Q));const Te=J.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),$e=new RegExp(`#let\\s+${Te}\\s*=\\s*"([^"]*)"`);for(const ue of a){const xe=ue.match($e);if(xe){K=xe[1];break}}if(K.startsWith("#"))continue}const de=K.trim().replace(/[/\\:*?"<>|]/g,"_");if(de)return de}}return"output"}async function Z(e){!o.selectedTemplate||!e.trim()||(r(d,""),e.includes("![")&&kt("image-path")&&We("image-path"),clearTimeout(S),S=setTimeout(async()=>{r(k,!0);try{o.typstSource=await xt(e,o.selectedTemplate),window.go?.main?.App?.CompileSVG?o.svgPages=await window.go.main.App.CompileSVG(o.typstSource,o.documentDir):o.svgPages=await Et(o.typstSource,o.documentDir||void 0)}catch(a){const s=a instanceof Error?a.message:String(a);console.error("Convert failed:",s),r(d,s,!0),/image|图片|not found|file not|读取/.test(s.toLowerCase())&&setTimeout(()=>We("image-error"),500)}finally{r(k,!1)}},500))}async function he(){if(!(!o.selectedTemplate||!o.markdown.trim())){r(d,"");try{if(window.go?.main?.App?.SavePDF){await window.go.main.App.SavePDF(o.markdown,o.selectedTemplate,o.documentDir);return}const e=await Dt(o.markdown,o.selectedTemplate,o.documentDir||void 0),a=URL.createObjectURL(e),s=document.createElement("a");s.href=a,s.download=ge(o.typstSource)+".pdf",s.click(),URL.revokeObjectURL(a)}catch(e){const a=e instanceof Error?e.message:String(e);console.error("Download failed:",a),r(d,a,!0)}}}async function we(){try{let e,a;if(window.go?.main?.App?.OpenFiles){const s=await window.go.main.App.OpenFiles();if(!s||s.length===0)return;a=new Map;const p=[];e=[];for(const T of s)if(T.isZip&&T.path&&window.go.main.App.ImportBatchZip)try{const z=await window.go.main.App.ImportBatchZip(T.path);p.push(z)}catch(z){console.error("ImportBatchZip failed:",z)}else T.isZip||(a.set(T.name,T.dir),e.push(new File([T.content],T.name,{type:"text/markdown"})));if(e.length===0&&p.length===0)return;await Ge.processFiles(e,"/",a,p.length>0?p:void 0);return}else e=await new Promise(s=>{const p=document.createElement("input");p.type="file",p.accept=".md,.markdown,.txt,.zip",p.multiple=!0,p.onchange=()=>s(Array.from(p.files??[])),p.click()});if(e.length===0)return;await Ge.processFiles(e,"/",a)}catch(e){const a=e instanceof Error?e.message:String(e);r(d,a,!0)}}Ve(()=>{window.runtime?.EventsOn&&(window.runtime.EventsOn("menu:open",we),window.runtime.EventsOn("menu:export",he),window.runtime.EventsOn("menu:settings",()=>ee("/settings")),window.runtime.EventsOn("menu:templates",()=>ee("/settings")));function e(a){(a.metaKey||a.ctrlKey)&&a.key===","&&(a.preventDefault(),ee("/settings")),(a.metaKey||a.ctrlKey)&&a.shiftKey&&(a.key==="t"||a.key==="T")&&(a.preventDefault(),ee("/settings"))}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)});var f=Ht(),v=je(f),C=i(v),g=i(C);Zt(g,{get selected(){return o.selectedTemplate},onbeforechange:Fe});var j=c(g,2);{var se=e=>{var a=Wt();_(e,a)};A(j,e=>{t(k)&&e(se)})}l(C);var W=c(C,2),_e=i(W);{var Ce=e=>{var a=Gt(),s=i(a,!0);l(a),ve(()=>{V(a,"title",t(d)),Ee(s,t(d))}),_(e,a)};A(_e,e=>{t(d)&&e(Ce)})}var O=c(_e,2);let Y;var G=i(O),Qe=i(G);At(Qe,{size:14}),l(G);var ie=c(G,2),et=i(ie);Lt(et,{size:14}),l(ie);var Ae=c(ie,2),tt=i(Ae);Mt(tt,{size:14}),l(Ae),l(O);var be=c(O,2),at=i(be);$t(at,{size:14}),ct(2),l(be),l(W),ae(W,e=>B=e,()=>B),l(v);var Ke=c(v,2);{var nt=e=>{var a=qt(),s=i(a);ze(s,{size:13});var p=c(s,4);Je(p,17,()=>t(m),gt,(T,z,ce)=>{var K=Xt(),de=je(K);{var J=ue=>{var xe=Vt();_(ue,xe)};A(de,ue=>{ce>0&&ue(J)})}var Q=c(de,2),Te=i(Q),$e=c(Te);Pt($e,{size:10}),l(Q),ve(()=>{V(Q,"href",t(z).url),Ee(Te,`${t(z).displayName??""} `)}),_(T,K)}),l(a),_(e,a)};A(Ke,e=>{t(m).length>0&&e(nt)})}var le=c(Ke,2);let Ne;var ye=i(le),rt=i(ye);ht(rt,{onchange:Z,get scrollRatio(){return t(N)},onscroll:e=>{t(L)!=="preview"&&(r(L,"editor"),r(X,e,!0),setTimeout(()=>{r(L,null)},100))},get value(){return o.markdown},set value(e){o.markdown=e}}),l(ye);var ke=c(ye,2),Le=c(ke,2),ot=i(Le);wt(ot,{get svgPages(){return o.svgPages},get scrollRatio(){return t(X)},onscroll:e=>{t(L)!=="editor"&&(r(L,"preview"),r(N,e,!0),setTimeout(()=>{r(L,null)},100))}}),l(Le),l(le),ae(le,e=>U=e,()=>U);var Me=c(le,2),Ue=c(i(Me),4),Be=i(Ue),Ie=c(Be,2),st=c(Ie,2);l(Ue),l(Me),ae(Me,e=>$=e,()=>$),ve(()=>{Y=De(O,1,"toolbar-hidden-group svelte-1uha8ag",null,Y,{visible:t(I)}),V(G,"title",`设置 (${u},)`),V(ie,"title",`打开文件 (${u}O)`),V(be,"title",`导出 PDF (${u}E)`),Ne=De(le,1,"editor-layout svelte-1uha8ag",null,Ne,{dragging:t(q)}),Ze(ye,`flex: ${t(re)??""}`),Ze(Le,`flex: ${1-t(re)}`)}),h("mousemove",v,pe),Oe("mouseenter",W,M),Oe("mouseleave",W,F),h("click",G,()=>ee("/settings")),h("click",ie,we),h("click",Ae,()=>ee("/batch")),h("click",be,he),h("pointerdown",ke,oe),h("pointermove",ke,Pe),h("pointerup",ke,me),h("click",Be,n),h("click",Ie,b),h("click",st,H),_(ne,f),He()}Ye(["mousemove","click","pointerdown","pointermove","pointerup"]);export{wa as component};
