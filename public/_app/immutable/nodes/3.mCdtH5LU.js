import{c as Xe,a as f,f as b}from"../chunks/DE3Q9Awg.js";import{o as qe,a as lt}from"../chunks/CJTN17t5.js";import{f as De,p as Ge,P as Ye,g as t,b as r,t as me,a as He,d as w,s as c,c as i,r as l,u as ne,O as ct}from"../chunks/DkUshctD.js";import{d as Je,a as h,s as Se,e as ze}from"../chunks/Xh7j0qJd.js";import{l as dt,s as vt,p as ut,i as F}from"../chunks/xO5lRXbR.js";import{I as pt,s as mt,a as Pe,b as Y,e as Qe,r as ft,c as Ze,i as gt}from"../chunks/BBgSnbQe.js";import{b as re}from"../chunks/sksWJ-dI.js";import{E as ht}from"../chunks/Dypf2YIG.js";import{P as _t}from"../chunks/z_z3yBiK.js";import{t as wt,c as bt,f as yt,s as kt,a as We}from"../chunks/T5HYuxXj.js";import{b as Tt}from"../chunks/Bm6imCI2.js";import{g as G}from"../chunks/49MYxscy.js";import{t as Re,c as xt,b as Et,d as Dt,g as St}from"../chunks/BgdB7GQd.js";import"../chunks/C8M2xYoJ.js";import{T as $e,S as Pt}from"../chunks/CWzC-WEw.js";import{S as Rt}from"../chunks/DiU14f1J.js";import{e as s,f as Ve}from"../chunks/BCTB1wnQ.js";import{e as Ct,r as Ft}from"../chunks/CWZOTtjW.js";import{S as At}from"../chunks/dzH4J3Rn.js";import{F as Lt,L as Mt}from"../chunks/C0UVGYz6.js";import{D as jt}from"../chunks/C9orDFqI.js";import{E as Ot}from"../chunks/Qz3hdTTS.js";function zt(se,S){const g=dt(S,["children","$$slots","$$events","$$legacy"]);const T=[["path",{d:"m6 9 6 6 6-6"}]];pt(se,vt({name:"chevron-down"},()=>g,{get iconNode(){return T},children:(v,x)=>{var d=Xe(),R=De(d);mt(R,S,"default",{}),f(v,d)},$$slots:{default:!0}}))}var $t=b('<span class="selector-warn svelte-17yjec1" title="缺少字体"><!></span>'),Kt=b('<div class="selector-search svelte-17yjec1"><!> <input type="text" placeholder="搜索模板…" class="svelte-17yjec1"/></div>'),Nt=b('<span class="option-warn svelte-17yjec1" title="缺少字体"><!></span>'),Ut=b('<button role="option"><span class="option-label svelte-17yjec1"> </span> <!></button>'),Bt=b('<div class="selector-empty-guide svelte-17yjec1"><!> <span>尚未安装模板</span> <button class="guide-link svelte-17yjec1">前往模板商店</button></div>'),It=b('<div class="selector-empty svelte-17yjec1">无匹配模板</div>'),Zt=b('<div class="selector-dropdown svelte-17yjec1" role="listbox"><!> <div class="selector-options svelte-17yjec1"><!> <!></div></div>'),Wt=b('<div class="selector-wrapper svelte-17yjec1"><button aria-haspopup="listbox" aria-label="选择模板"><span class="selector-label svelte-17yjec1"> </span> <!> <!></button> <!></div>');function Vt(se,S){Ge(S,!0);let g=ut(S,"selected",15,""),T=ne(()=>Re.templates),v=w(!1),x=w(""),d=w(0),R,B,H=w(void 0),O=ne(()=>t(T).length>=7),A=ne(()=>t(T).filter(n=>{if(!t(x))return!0;const y=t(x).toLowerCase();return(n.displayName||n.name).toLowerCase().includes(y)||n.name.toLowerCase().includes(y)})),oe=ne(()=>t(T).find(n=>n.name===g())?.displayName||t(T).find(n=>n.name===g())?.name||g()||"选择模板"),J=ne(()=>(t(T).find(n=>n.name===g())?.missingFonts?.length??0)>0);qe(()=>(Re.load().then(()=>{!g()&&t(T).length>0&&(S.onbeforechange?S.onbeforechange(t(T)[0].name):g(t(T)[0].name))}),document.addEventListener("pointerdown",L,!0),()=>document.removeEventListener("pointerdown",L,!0)));function I(){r(v,!t(v)),t(v)&&(r(x,""),r(d,Math.max(0,t(A).findIndex(n=>n.name===g())),!0),requestAnimationFrame(()=>t(H)?.focus()))}function Z(n){r(v,!1),r(x,""),S.onbeforechange?S.onbeforechange(n):g(n),B?.focus()}function W(n){if(!t(v)){(n.key==="Enter"||n.key===" "||n.key==="ArrowDown")&&(n.preventDefault(),I());return}switch(n.key){case"ArrowDown":n.preventDefault(),r(d,Math.min(t(d)+1,t(A).length-1),!0);break;case"ArrowUp":n.preventDefault(),r(d,Math.max(t(d)-1,0),!0);break;case"Enter":n.preventDefault(),t(A)[t(d)]&&Z(t(A)[t(d)].name);break;case"Escape":n.preventDefault(),r(v,!1),B?.focus();break}}function L(n){t(v)&&R&&!R.contains(n.target)&&r(v,!1)}Ye(()=>{t(x),r(d,0)});var z=Wt(),M=i(z);let fe;var ie=i(M),Ce=i(ie,!0);l(ie);var ge=c(ie,2);{var j=n=>{var y=$t(),Q=i(y);$e(Q,{size:11}),l(y),f(n,y)};F(ge,n=>{t(J)&&n(j)})}var $=c(ge,2);zt($,{size:12}),l(M),re(M,n=>B=n,()=>B);var he=c(M,2);{var Fe=n=>{var y=Zt(),Q=i(y);{var Ae=_=>{var u=Kt(),P=i(u);Rt(P,{size:12});var m=c(P,2);ft(m),re(m,C=>r(H,C),()=>t(H)),l(u),Tt(m,()=>t(x),C=>r(x,C)),f(_,u)};F(Q,_=>{t(O)&&_(Ae)})}var _e=c(Q,2),V=i(_e);Qe(V,19,()=>t(A),_=>_.name,(_,u,P)=>{var m=Ut();let C;var E=i(m),k=i(E,!0);l(E);var X=c(E,2);{var le=K=>{var ee=Nt(),q=i(ee);$e(q,{size:10}),l(ee),f(K,ee)};F(X,K=>{(t(u).missingFonts?.length??0)>0&&K(le)})}l(m),me(()=>{C=Pe(m,1,"selector-option svelte-17yjec1",null,C,{selected:t(u).name===g(),highlighted:t(P)===t(d)}),Y(m,"aria-selected",t(u).name===g()),Se(k,t(u).displayName||t(u).name)}),h("click",m,()=>Z(t(u).name)),ze("pointerenter",m,()=>r(d,t(P),!0)),f(_,m)});var we=c(V,2);{var be=_=>{var u=Xe(),P=De(u);{var m=E=>{var k=Bt(),X=i(k);Pt(X,{size:16});var le=c(X,4);l(k),h("click",le,()=>{r(v,!1),G("/store-templates")}),f(E,k)},C=E=>{var k=It();f(E,k)};F(P,E=>{t(T).length===0?E(m):E(C,!1)})}f(_,u)};F(we,_=>{t(A).length===0&&_(be)})}l(_e),l(y),wt(3,y,()=>yt,()=>({y:-4,duration:150,easing:bt})),f(n,y)};F(he,n=>{t(v)&&n(Fe)})}l(z),re(z,n=>R=n,()=>R),me(()=>{fe=Pe(M,1,"selector-trigger svelte-17yjec1",null,fe,{open:t(v)}),Y(M,"aria-expanded",t(v)),Se(Ce,t(oe))}),h("keydown",z,W),h("click",M,I),f(se,z),He()}Je(["keydown","click"]);var Xt=b('<div class="status-dot svelte-1uha8ag"></div>'),qt=b('<span class="error-msg svelte-1uha8ag"> </span>'),Gt=b('<span class="font-sep svelte-1uha8ag">、</span>'),Yt=b('<!> <a target="_blank" rel="noopener noreferrer" class="svelte-1uha8ag"> <!></a>',1),Ht=b('<div class="font-warning svelte-1uha8ag"><!> <span class="svelte-1uha8ag">缺少字体：</span> <!></div>'),Jt=b('<div class="toolbar svelte-1uha8ag" style="--wails-draggable:drag"><div class="toolbar-left svelte-1uha8ag"><!> <!></div> <div class="toolbar-right svelte-1uha8ag"><!> <div><button class="btn-toolbar svelte-1uha8ag" aria-label="设置"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="打开文件"><!></button> <button class="btn-toolbar svelte-1uha8ag" aria-label="批量转换" title="批量转换"><!></button></div> <button class="btn-export svelte-1uha8ag" aria-label="导出 PDF"><!> <span class="svelte-1uha8ag">导出 PDF</span></button></div></div> <!> <div><div class="pane svelte-1uha8ag"><!></div> <div class="divider svelte-1uha8ag" role="separator" aria-label="拖动调整宽度" aria-orientation="vertical"><div class="divider-grip svelte-1uha8ag"><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span><span class="svelte-1uha8ag"></span></div></div> <div class="pane svelte-1uha8ag"><!></div></div> <dialog class="confirm-dialog svelte-1uha8ag"><h3 class="svelte-1uha8ag">切换模板</h3> <p class="svelte-1uha8ag">当前编辑器中有内容，切换模板后如何处理？</p> <div class="dialog-actions svelte-1uha8ag"><button class="dialog-btn primary svelte-1uha8ag">使用示例内容</button> <button class="dialog-btn svelte-1uha8ag">保留当前内容</button> <button class="dialog-btn svelte-1uha8ag">取消</button></div></dialog>',1);function ya(se,S){Ge(S,!0);let g=ne(()=>Re.templates.find(e=>e.name===s.selectedTemplate)?.missingFonts??[]);const v=typeof navigator<"u"&&/Mac|iPhone|iPad/.test(navigator.userAgent)?"⌘":"Ctrl+";let x=w(!1),d=w(""),R=w(!1);Ye(()=>{s.pendingExternalLoad&&(s.pendingExternalLoad=!1,r(R,!1),Ae(s.markdown),V(s.markdown))});let B=w(0),H=w(0),O=w(null),A,oe=w(.5),J=w(!1),I,Z,W=w(!1),L;function z(){clearTimeout(L),r(W,!0)}function M(){clearTimeout(L),L=setTimeout(()=>{r(W,!1)},800)}function fe(e){if(!Z)return;const a=Z.getBoundingClientRect(),o=60;e.clientX>=a.left-o&&e.clientX<=a.right+o&&e.clientY>=a.top-o&&e.clientY<=a.bottom+o?z():t(W)&&(clearTimeout(L),L=setTimeout(()=>{r(W,!1)},800))}lt(()=>{clearTimeout(L)});function ie(e){r(J,!0),e.target.setPointerCapture(e.pointerId)}function Ce(e){if(!t(J)||!I)return;const a=I.getBoundingClientRect(),o=(e.clientX-a.left)/a.width;r(oe,Math.min(.8,Math.max(.2,o)),!0)}function ge(){r(J,!1)}let j=w(""),$;async function he(e){try{const a=await St(e);a&&(s.markdown=a,V(s.markdown))}catch(a){console.error("Failed to load example:",a)}}async function Fe(e){e!==s.selectedTemplate&&(s.markdown.trim()?(r(j,e,!0),$?.showModal()):(s.selectedTemplate=e,await he(e)))}function n(){$?.close(),s.selectedTemplate=t(j),he(t(j)),r(j,"")}function y(){$?.close(),s.selectedTemplate=t(j),V(s.markdown),r(j,"")}function Q(){$?.close(),r(j,"")}function Ae(e){if(t(R))return;r(R,!0);const a=Ct(e);if(!a)return;const o=Ft(a,Re.templates);o&&o!==s.selectedTemplate&&(s.selectedTemplate=o)}function _e(e){const a=e.split(`
`);for(let o=1;o<=5;o++){const p="=".repeat(o)+" ",D="=".repeat(o+1);for(const N of a){const ve=N.trim();if(!ve.startsWith(p)||o<5&&ve.startsWith(D))continue;let U=ve.slice(p.length).trim();if(U.startsWith("#")){let te=U.slice(1);const ae=te.search(/[.( ]/);ae>0&&(te=te.slice(0,ae));const xe=te.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Oe=new RegExp(`#let\\s+${xe}\\s*=\\s*"([^"]*)"`);for(const pe of a){const Ee=pe.match(Oe);if(Ee){U=Ee[1];break}}if(U.startsWith("#"))continue}const ue=U.trim().replace(/[/\\:*?"<>|]/g,"_");if(ue)return ue}}return"output"}async function V(e){!s.selectedTemplate||!e.trim()||(r(d,""),e.includes("![")&&kt("image-path")&&We("image-path"),clearTimeout(A),A=setTimeout(async()=>{r(x,!0);try{s.typstSource=await xt(e,s.selectedTemplate),window.go?.main?.App?.CompileSVG?s.svgPages=await window.go.main.App.CompileSVG(s.typstSource,s.documentDir):s.svgPages=await Et(s.typstSource,s.documentDir||void 0)}catch(a){const o=a instanceof Error?a.message:String(a);console.error("Convert failed:",o),r(d,o,!0),/image|图片|not found|file not|读取/.test(o.toLowerCase())&&setTimeout(()=>We("image-error"),500)}finally{r(x,!1)}},500))}async function we(){if(!(!s.selectedTemplate||!s.markdown.trim())){r(d,"");try{if(window.go?.main?.App?.SavePDF){await window.go.main.App.SavePDF(s.markdown,s.selectedTemplate,s.documentDir);return}const e=await Dt(s.markdown,s.selectedTemplate,s.documentDir||void 0),a=URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download=_e(s.typstSource)+".pdf",o.click(),URL.revokeObjectURL(a)}catch(e){const a=e instanceof Error?e.message:String(e);console.error("Download failed:",a),r(d,a,!0)}}}async function be(){try{let e,a;if(window.go?.main?.App?.OpenFiles){const o=await window.go.main.App.OpenFiles();if(!o||o.length===0)return;a=new Map;const p=[];e=[];for(const D of o)if(D.isZip&&D.path&&window.go.main.App.ImportBatchZip)try{const N=await window.go.main.App.ImportBatchZip(D.path);p.push(N)}catch(N){console.error("ImportBatchZip failed:",N)}else D.isZip||(a.set(D.name,D.dir),e.push(new File([D.content],D.name,{type:"text/markdown"})));if(e.length===0&&p.length===0)return;await Ve.processFiles(e,"/",a,p.length>0?p:void 0);return}else e=await new Promise(o=>{const p=document.createElement("input");p.type="file",p.accept=".md,.markdown,.txt,.zip",p.multiple=!0,p.onchange=()=>o(Array.from(p.files??[])),p.click()});if(e.length===0)return;await Ve.processFiles(e,"/",a)}catch(e){const a=e instanceof Error?e.message:String(e);r(d,a,!0)}}qe(()=>{window.runtime?.EventsOn&&(window.runtime.EventsOn("menu:open",be),window.runtime.EventsOn("menu:export",we),window.runtime.EventsOn("menu:settings",()=>G("/settings")),window.runtime.EventsOn("menu:templates",()=>G("/settings")));function e(a){(a.metaKey||a.ctrlKey)&&a.key===","&&(a.preventDefault(),G("/settings")),(a.metaKey||a.ctrlKey)&&a.shiftKey&&(a.key==="t"||a.key==="T")&&(a.preventDefault(),G("/settings"))}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)});var _=Jt(),u=De(_),P=i(u),m=i(P);Vt(m,{get selected(){return s.selectedTemplate},onbeforechange:Fe});var C=c(m,2);{var E=e=>{var a=Xt();f(e,a)};F(C,e=>{t(x)&&e(E)})}l(P);var k=c(P,2),X=i(k);{var le=e=>{var a=qt(),o=i(a,!0);l(a),me(()=>{Y(a,"title",t(d)),Se(o,t(d))}),f(e,a)};F(X,e=>{t(d)&&e(le)})}var K=c(X,2);let ee;var q=i(K),et=i(q);At(et,{size:14}),l(q);var ce=c(q,2),tt=i(ce);Lt(tt,{size:14}),l(ce);var Le=c(ce,2),at=i(Le);Mt(at,{size:14}),l(Le),l(K);var ye=c(K,2),nt=i(ye);jt(nt,{size:14}),ct(2),l(ye),l(k),re(k,e=>Z=e,()=>Z),l(u);var Ke=c(u,2);{var rt=e=>{var a=Ht(),o=i(a);$e(o,{size:13});var p=c(o,4);Qe(p,17,()=>t(g),gt,(D,N,ve)=>{var U=Yt(),ue=De(U);{var te=pe=>{var Ee=Gt();f(pe,Ee)};F(ue,pe=>{ve>0&&pe(te)})}var ae=c(ue,2),xe=i(ae),Oe=c(xe);Ot(Oe,{size:10}),l(ae),me(()=>{Y(ae,"href",t(N).url),Se(xe,`${t(N).displayName??""} `)}),f(D,U)}),l(a),f(e,a)};F(Ke,e=>{t(g).length>0&&e(rt)})}var de=c(Ke,2);let Ne;var ke=i(de),st=i(ke);ht(st,{onchange:V,get scrollRatio(){return t(B)},onscroll:e=>{t(O)!=="preview"&&(r(O,"editor"),r(H,e,!0),setTimeout(()=>{r(O,null)},100))},get value(){return s.markdown},set value(e){s.markdown=e}}),l(ke);var Te=c(ke,2),Me=c(Te,2),ot=i(Me);_t(ot,{get svgPages(){return s.svgPages},get scrollRatio(){return t(H)},onscroll:e=>{t(O)!=="editor"&&(r(O,"preview"),r(B,e,!0),setTimeout(()=>{r(O,null)},100))}}),l(Me),l(de),re(de,e=>I=e,()=>I);var je=c(de,2),Ue=c(i(je),4),Be=i(Ue),Ie=c(Be,2),it=c(Ie,2);l(Ue),l(je),re(je,e=>$=e,()=>$),me(()=>{ee=Pe(K,1,"toolbar-hidden-group svelte-1uha8ag",null,ee,{visible:t(W)}),Y(q,"title",`设置 (${v},)`),Y(ce,"title",`打开文件 (${v}O)`),Y(ye,"title",`导出 PDF (${v}E)`),Ne=Pe(de,1,"editor-layout svelte-1uha8ag",null,Ne,{dragging:t(J)}),Ze(ke,`flex: ${t(oe)??""}`),Ze(Me,`flex: ${1-t(oe)}`)}),h("mousemove",u,fe),ze("mouseenter",k,z),ze("mouseleave",k,M),h("click",q,()=>G("/settings")),h("click",ce,be),h("click",Le,()=>G("/batch")),h("click",ye,we),h("pointerdown",Te,ie),h("pointermove",Te,Ce),h("pointerup",Te,ge),h("click",Be,n),h("click",Ie,y),h("click",it,Q),f(se,_),He()}Je(["mousemove","click","pointerdown","pointermove","pointerup"]);export{ya as component};
